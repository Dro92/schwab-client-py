name: Publish - PyPI Upload Upon Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  pypi-publish:
      runs-on: ubuntu-latest
      environment:
        name: pypi
        url: https://pypi.org/project/${{ github.event.repository.name }}
      permissions:
        id-token: write
        contents: read
      steps:
        - name: Check out repository
          uses: actions/checkout@v4
        - name: Set up python
          id: setup-python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'
        - name: Install Poetry
          uses: snok/install-poetry@v1
          with:
            version: 2.1.3
            virtualenvs-create: true
            virtualenvs-in-project: true
            virtualenvs-path: .venv
        - name: Install project dependencies
          run: poetry install --no-interaction --no-root
        - name: Build packge
          run: poetry build
        - name: Publish package
          uses: pypa/gh-action-pypi-publish@release/v1
